<!DOCTYPE html>
<meta charset="UTF-8">
<title>Irish Snap!</title>
<style>
    .card-table {
        width: min(80vw, 80vh);
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        background-color: darkgreen;
        position: relative;
        border: min(4.8vw, 4.8vh) solid saddlebrown;
        font-size: min(2vw, 2vh);
        font-family: sans-serif;
    }

    .card-table-player-name {
        font-size: min(8vw, 8vh);
    }

    .card-table-play-pile {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: min(15vw, 15vh);
    }

    .speech-bubble {
        position: absolute;
        bottom: 0;
        right: 0;
        width: min(5vw, 5vh);
        height: min(2.5vw, 2.5vh);
        border-radius: 50%;
        background: white;
        filter: drop-shadow(1px 1px 0 #000) drop-shadow(-1px 1px 0 #000) drop-shadow(1px -1px 0 #000) drop-shadow(-1px -1px 0 #000);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .speech-bubble::before {
        content: "";
        position: absolute;
        top: -20%;
        left: -20%;
        border-radius: 0% 100% 0 0;
        width: min(2vw, 2vh);
        height: min(1vw, 1vh);
        box-shadow:  min(0.7vw, 0.7vh) 0 0 white;
    }

    .playing-card {
        width: min(10vw, 10vh);
    }

    li {
        list-style-type: none;
    }

    button {
        font-size: 300%;
        margin: 5px;
    }
</style>
<script type="module">
    import { h, Component, render } from 'https://esm.sh/preact@10.11.3'
    import { signal } from "https://esm.sh/@preact/signals@1.1.3"
    import htm from "https://esm.sh/htm@3.1.1"
    import { io } from "/socket.io/socket.io.esm.min.js"

    import { cardValues, cardSuits, allCards } from "./shared.js"

    const socket = io()

    // Initialize htm with Preact
    const html = htm.bind(h);

    const state = signal({
        currentPlayer: {
            id: undefined,
            name: undefined,
        },
        lastMove: undefined,
        playedLast: undefined,
        players: {},
        status: "Need to deal out the cards",
    })

    const messageFeed = signal([])
    function alertMessage(message) {
        messageFeed.value = [message, ...messageFeed.value]
    }

    let playerId = undefined
    socket.on("connect", () => {
        socket.emit("join", {
            name: currentPlayer,
            room: "default",
        })
    })
    
    socket.on("updateState", (newState) => {
        state.value = newState
        if (state.value.status !== "valid") {
            alertMessage(state.value.status)
        }
    })
    const regex_emoji = /[\p{Extended_Pictographic}\u{1F3FB}-\u{1F3FF}\u{1F9B0}-\u{1F9B3}]/u
    let currentPlayer
    do {
        currentPlayer = [...prompt("Choose an emoji for your username (win+. to open emoji picker):")][0]
    } while (!regex_emoji.test(currentPlayer))
    
    // preload card images
    allCards.forEach((card) => {
        new Image().src = getPlayingCardSvgPath(card)
    })

    function sayAndPlay(said) {
        if (state.value.status !== "valid") {
            alertMessage("Nuh uh!")
            return
        }
        socket.emit("move:sayAndPlay", said)
    }

    function slap() {
        if (state.value.status !== "valid") {
            alertMessage("Nuh uh!")
            return
        }
        socket.emit("move:slap", null)
    }

    function deal() {
        if(state.value.status === "valid") {
            alertMessage("Nuh uh!")
            return
        }
        alertMessage("dealt")
        socket.emit("move:deal", null)
    }

    function getPlayingCardSvgPath(card) {
        let svgIdentifier = "uu" // fallback
        if (card) {
            const value = card[0]
            const suit = card[1]

            svgIdentifier = `${value === "10" ? "10" : value[0]}${suit[0]}`
        }

        return `images/Minicard_${svgIdentifier}.svg`
    }

    function PlayingCard({ card }) {
        return html`<img class="playing-card" src=${getPlayingCardSvgPath(card)} />`
    }

    function SayAndPlayButton({ cardValue }) {
        return html`<button onClick=${() => sayAndPlay(cardValue)}>${cardValue}</button>`
    }

    function CardTable({ state }) {
        const players = state.players
        const nPlayers = Object.keys(players).length
        const myPlayerId = state.currentPlayer.id
        return html`
            <div class="card-table">
                ${Object.entries(players).map(([playerId, playerData], i) => html`
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: rotate(${i*(360.0/nPlayers)}deg) translate(max(-40vw, -40vh));
                    ">
                        <div class="card-table-seat" style="
                            transform: rotate(-${i*(360.0/nPlayers)}deg) translate(-50%, -50%);
                            background: white;
                            border: min(1.6vw, 1.6vh) solid ${playerId === myPlayerId ? "black" : "saddlebrown"};
                            border-radius: 50%;
                            width: min(16vw, 16vh);
                            height: min(16vw, 16vh);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <span class="card-table-player-name" style="">${playerData.name}</span>
                            ${state.lastMove?.action === "sayAndPlay" && state.lastMove?.player === playerId && html`
                                <div class="speech-bubble">
                                    ${state.lastMove?.player === playerId ? state.lastMove?.said : undefined}
                                </div>
                            `}
                        </div>
                    </div>
                `)}
                <div class="card-table-play-pile">
                    <${PlayingCard} card=${state.playedLast} />
                </div>
            </div>
        `
    }

    function App(props) {
        const s = state.value;
        // TODO: contesting rule violations should be done by players, not the server
        // TODO: timeout if player takes too long
        // TODO: who slapped last, not who slapped first
        // TODO: rounds & keeping track if someone wins
        // TODO: show hand and central pile size
        // TODO: starting player (for round) token
        return html`
            <div>
                <div style="
                    display: flex;
                    justify-content: center;
                ">
                    <${CardTable} state=${s} />
                </div>
                <div style="
                    display: flex;
                    justify-content: center;
                ">
                    <div>
                        <div>${s.currentPlayer.name} controls</div>
                        <div>${cardValues.map((cardValue) => html`<${SayAndPlayButton} cardValue=${cardValue} />`)}</div>
                        <div>
                            <button onClick=${() => slap()}>Slap!</button>
                            <button onClick=${() => deal()}>Deal</button>
                        </div>
                    </div>
                    <ul>
                        ${messageFeed.value.map((message) => html`<li>${message}</li>`)}
                    </ul>
                </div>
            </div>
        `
    }
    
    render(html`<${App} />`, document.body);
</script>