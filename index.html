<!DOCTYPE html>
<meta charset="UTF-8">
<script type="module">
    import { h, Component, render } from 'https://esm.sh/preact';
    import { signal } from "https://esm.sh/@preact/signals";
    import htm from "https://esm.sh/htm";
    import produce from "https://esm.sh/immer"

    // Initialize htm with Preact
    const html = htm.bind(h);

    const invalidStateException = Symbol("Invalid State Exception")
    const cardValues = ["Ace", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Jack", "Queen", "King"]
    const cardSuits = ["Spades", "Hearts", "Diamonds", "Clubs"]
    const allCards = cardValues.flatMap((v) => cardSuits.map((s) => [v, s]));
    class Server {
        constructor(clientUpdateState) {
            // initial state
            const hands = this.#deal(3)
            this.state = {
                status: "valid",
                played: [],
                said: [],
                players: {
                    "a": {
                        hand: hands[0],
                        updateState: clientUpdateState,
                    },
                    "b": {
                        hand: hands[1],
                        updateState: (_newState) => {},
                    },
                    "c": {
                        hand: hands[2],
                        updateState: (_newState) => {},
                    }
                },
            }
        }

        #deal(numPlayers) {
            const deck = allCards.slice()
            this.#shuffleArray(deck)
            return this.#splitArray(deck, numPlayers)
        }
        #shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        #splitArray(array, nChunks) {
            let result = [];
            for (let i = nChunks; i > 0; i--) {
                result.push(array.splice(0, Math.ceil(array.length / i)));
            }
            return result;
        }

        #expectedToSayNext() {
            const saidLast = this.state.said[this.state.said.length - 1] ?? "K"
            return cardValues[(cardValues.indexOf(saidLast) + 1) % cardValues.length]
        }

        #shouldSlap() {
            const saidLast = this.state.said[this.state.said.length - 1] ?? NaN
            const playedLastLast = this.state.played[this.state.played.length - 2]?.[0] ?? NaN
            const playedLast = this.state.played[this.state.played.length - 1]?.[0] ?? NaN

            return saidLast === playedLast || playedLastLast === playedLast || playedLast === "J"
        }

        #updateState(stateUpdater) {
            const newState = produce(this.state, stateUpdater)
            console.log(newState)
            this.state = newState
            Object.values(this.state.players).forEach(player => {
                player.updateState({
                    playedLast: this.state.played[this.state.played.length - 1],
                    handSize: player.hand.length,
                    status: this.state.status,
                })
            })
        }

        sendReceiveAction(player, action, payload) {
            if (this.state.status !== "valid") {
                return
            }

            switch (action) {
                case "sayAndPlay":
                    const said = payload
                    const expectedToSayNext = this.#expectedToSayNext()

                    this.#updateState(draftState => {
                        if (this.#shouldSlap()) {
                            draftState.status = `Somebody should've slapped!`
                        }
                        const played = draftState.players[player].hand.pop()
                        draftState.played.push(played)
                        draftState.said.push(said)
                        if (said !== expectedToSayNext) {
                            draftState.status = `Player ${player} should've said ${expectedToSayNext}!`
                        }
                    })
                    break
                case "slap":
                    this.#updateState(draftState => {
                        if (this.#shouldSlap()) {
                            draftState.status = `Player ${player} slapped first!`
                        } else {
                            draftState.status = `Player ${player} shouldn't have slapped!`
                        }
                    })
                    break
                default:
                    break
            }
        }
    }

    const state = signal({
        playedLast: undefined,
        handSize: 0,
        status: "valid",
    })

    function updateState(newState) {
        state.value = newState
        if (state.value.status !== "valid") {
            setTimeout(alert(state.value.status), 1)
        }
    }
    const server = new Server(updateState)
    const currentPlayer = "a"

    function sayAndPlay(said) {
        if (state.value.status !== "valid") {
            alert("Nuh uh!")
            return
        }
        server.sendReceiveAction(currentPlayer, "sayAndPlay", said);
    }

    function slap() {
        if (state.value.status !== "valid") {
            alert("Nuh uh!")
            return
        }
        server.sendReceiveAction(currentPlayer, "slap", null)
    }

    function PlayingCard({ card }) {
        let cardUnicode = "ðŸ‚¿"
        let color = "black"
        if (card) {
            const value = card[0]
            const suit = card[1]

            const valueIndex = cardValues.indexOf(value)
            const suitIndex = cardSuits.indexOf(suit)

            let offset = 0
            if (["Queen", "King"].includes(value)) {
                offset = 1 // skip "knight" card
            }
            cardUnicode = String.fromCodePoint(0x1F0A1 + suitIndex*0x10 + valueIndex + offset)
            if (["Diamonds", "Hearts"].includes(suit)) {
                color = "red"
            }
        }

        return html`<span style="font-size: 1000%; color: ${color}">${cardUnicode}</span>`
    }

    function SayAndPlayButton({ cardValue }) {
        return html`<button onClick=${() => sayAndPlay(cardValue)}>${cardValue}</button>`
    }

    function App(props) {
        const s = state.value;
        return html`
            <div>
                <div>${s.status}</div>
                <div><strong>Last played</strong>: <${PlayingCard} card=${s.playedLast} /></div>
                <div>${cardValues.map((cardValue) => html`<${SayAndPlayButton} cardValue=${cardValue} />`)}</div>
                <div><button onClick=${() => slap()}>Slap!</button></div>
            </div>`
    }
    
    render(html`<${App} />`, document.body);
</script>