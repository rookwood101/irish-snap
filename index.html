<!DOCTYPE html>
<script type="module">
    import { h, Component, render } from 'https://esm.sh/preact';
    import { signal } from "https://esm.sh/@preact/signals";
    import htm from "https://esm.sh/htm";
    import produce from "https://esm.sh/immer"

    // Initialize htm with Preact
    const html = htm.bind(h);

    const invalidStateException = Symbol("Invalid State Exception")
    const cardValues = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"]
    const cardSuits = ["Clubs", "Spades", "Hearts", "Diamonds"]
    const allCards = cardValues.flatMap((v) => cardSuits.map((s) => [v, s]));
    class Server {
        constructor(clientUpdateState) {
            // initial state
            const hands = this.#deal(3)
            this.state = {
                status: "valid",
                played: [],
                said: [],
                players: {
                    "a": {
                        hand: hands[0],
                        updateState: clientUpdateState,
                    },
                    "b": {
                        hand: hands[1],
                        updateState: (_newState) => {},
                    },
                    "c": {
                        hand: hands[2],
                        updateState: (_newState) => {},
                    }
                },
            }
        }

        #deal(numPlayers) {
            const deck = allCards.slice()
            this.#shuffleArray(deck)
            return this.#splitArray(deck, numPlayers)
        }
        #shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        #splitArray(array, nChunks) {
            let result = [];
            for (let i = nChunks; i > 0; i--) {
                result.push(array.splice(0, Math.ceil(array.length / i)));
            }
            return result;
        }

        #expectedToSayNext() {
            const saidLast = this.state.said[this.state.said.length - 1] ?? "K"
            return cardValues[(cardValues.indexOf(saidLast) + 1) % cardValues.length]
        }

        #updateState(stateUpdater) {
            const newState = produce(this.state, stateUpdater)
            console.log(newState)
            this.state = newState
            Object.values(this.state.players).forEach(player => {
                player.updateState({
                    played: this.state.played,
                    said: this.state.said,
                    handSize: player.hand.length,
                    status: this.state.status,
                })
            })
        }

        sendReceiveAction(player, action, payload) {
            if (this.state.status !== "valid") {
                return
            }

            switch (action) {
                case "sayAndPlay":
                    const said = payload
                    const expectedToSayNext = this.#expectedToSayNext()

                    this.#updateState(draftState => {
                        const played = draftState.players[player].hand.pop()
                        draftState.played.push(played)
                        draftState.said.push(said)
                        if (said !== expectedToSayNext) {
                            draftState.status = `You should've said ${expectedToSayNext}!`
                        }
                    })
                    break
                default:
                    break
            }
        }
    }

    const state = signal({
        played: [],
        said: [],
        handSize: 0,
        status: "valid",
    })

    function updateState(newState) {
        state.value = newState
        if (state.value.status !== "valid") {
            alert(state.value.status)
        }
    }
    const server = new Server(updateState)
    const currentPlayer = "a"

    function sayAndPlay(said) {
        if (state.value.status !== "valid") {
            alert("Nuh uh!")
            return
        }
        server.sendReceiveAction(currentPlayer, "sayAndPlay", said);
    }

    function slap() {
        if (state.value.status !== "valid") {
            alert("Nuh uh!")
            return
        }
        server.sendReceiveAction(currentPlayer, "slap", null)
    }

    function SayAndPlayButton({ cardValue }) {
        return html`<button onClick=${() => sayAndPlay(cardValue)}>${cardValue}</button>`
    }

    function App(props) {
        const s = state.value;
        const topCard = s.played[s.played.length - 1]
        return html`
            <div>
                <div>Debug state: <pre>${JSON.stringify(s, null, 2)}</pre></div>
                <div>${s.status}</div>
                <div><strong>Top of played</strong>: ${topCard}</div>
                <div>${cardValues.map((cardValue) => html`<${SayAndPlayButton} cardValue=${cardValue} />`)}</div>
                <div><button onClick=${() => slap()}>Slap!</button></div>
            </div>`
    }
    
    render(html`<${App} />`, document.body);
</script>